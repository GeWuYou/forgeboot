# å·¥ä½œæµåç§°ï¼šMain Branch CI/CD
# åŠŸèƒ½æè¿°ï¼š
#   æ­¤å·¥ä½œæµåœ¨å‘ main åˆ†æ”¯æ¨é€ä»£ç æ—¶è§¦å‘ï¼Œæ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š
#   1. è‡ªåŠ¨æ‰“è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ï¼ˆtagï¼‰
#   2. å‘å¸ƒ Java åŒ…åˆ° Maven Central å’Œ GitHub Packages
#   3. å¼ºåˆ¶é‡ç½® test åˆ†æ”¯ä¸ºå½“å‰ main çš„æœ€æ–°çŠ¶æ€
#
# è§¦å‘æ¡ä»¶ï¼š
#   - æ¨é€åˆ° main åˆ†æ”¯
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)

name: Main Branch CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

# æƒé™è®¾ç½®ï¼šå…è®¸ä½¿ç”¨ GITHUB_TOKEN æ¨é€ tag å’Œæäº¤å†…å®¹
permissions:
  contents: write
  packages: write

# ç¯å¢ƒå˜é‡å®šä¹‰
env:
  # è®¾ç½® Gradle ç”¨æˆ·ä¸»ç›®å½•è·¯å¾„ï¼Œé¿å…ç¼“å­˜å†²çª
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
  GITHUB_USERNAME: ${{ github.actor }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALUSERNAME }}
  ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.ORG_GRADLE_PROJECT_MAVENCENTRALPASSWORD }}
  ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEY }}
  ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYID }}
  ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.ORG_GRADLE_PROJECT_SIGNINGINMEMORYKEYPASSWORD }}

jobs:
  skip-check:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: Check skip keywords
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "ğŸ” Commit message: $COMMIT_MSG"

          # åˆç†çš„ skip å‰ç¼€
          SKIP_KEYWORDS=("[skip ci]" "[ci skip]" "[skip]" "skip-ci")

          SHOULD_SKIP=false
          for key in "${SKIP_KEYWORDS[@]}"; do
            if echo "$COMMIT_MSG" | grep -Fqi "$key"; then
              SHOULD_SKIP=true
              echo "â­ï¸ å‘ç°è·³è¿‡å…³é”®å­—: $key"
              break
            fi
          done

          echo "should_skip=$SHOULD_SKIP" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ æœ€ç»ˆ should_skip = $SHOULD_SKIP"

  # ä½œä¸šåç§°ï¼šAuto Tag Version
  # åŠŸèƒ½æè¿°ï¼š
  #   æ ¹æ®æœ€æ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾è‡ªåŠ¨ç”Ÿæˆå¹¶æ¨é€æ–°çš„ patch ç‰ˆæœ¬æ ‡ç­¾ã€‚
  # å‚æ•°è¯´æ˜ï¼š
  #   æ— æ˜¾å¼å‚æ•°ï¼Œä¾èµ– Git æäº¤å†å²ä¸ç°æœ‰ tag åˆ—è¡¨ã€‚
  # è¿”å›å€¼è¯´æ˜ï¼š
  #   æˆåŠŸåä¼šåœ¨è¿œç¨‹ä»“åº“åˆ›å»ºä¸€ä¸ªæ–°çš„å¸¦æœ‰ v å‰ç¼€çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ã€‚
  tag:
    name: Auto Tag Version
    runs-on: ubuntu-latest
    needs: skip-check
    if: needs.skip-check.outputs.should_skip == 'false'

    steps:
      # æ­¥éª¤ä¸€ï¼šæ£€å‡ºæºç ï¼Œå¹¶è·å–å®Œæ•´çš„ Git å†å²è®°å½•ç”¨äº tag æ“ä½œ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤äºŒï¼šæ¸…ç†æœ¬åœ° tag å¹¶å¼ºåˆ¶åŒæ­¥è¿œç¨‹ tag åŠ main åˆ†æ”¯
      - name: Delete all local tags and fetch remote tags
        run: |
          set -euo pipefail
          echo "ğŸ§¹ åˆ é™¤æ‰€æœ‰æœ¬åœ° tag..."
          git tag -l | xargs -r git tag -d || true

          echo "ğŸ” æ‹‰å–è¿œç¨‹ tag å’Œ main"
          git fetch --tags --force --prune
          git fetch origin main --force
          MAIN_COMMIT=$(git rev-parse origin/main)
          echo "ğŸ”— å½“å‰ main commit -> $MAIN_COMMIT"

      # æ­¥éª¤ä¸‰ï¼šæ ¹æ®å·²æœ‰ tag è‡ªåŠ¨ç”Ÿæˆä¸‹ä¸€ä¸ª patch ç‰ˆæœ¬å·å¹¶æ¨é€åˆ°è¿œç«¯
      - name: Create and push new semantic version tag
        run: |
          set -euo pipefail
          MAIN_COMMIT=$(git rev-parse origin/main)
          echo "ğŸ”— å½“å‰ main commit -> $MAIN_COMMIT"
          echo "ğŸ“¦ è·å–æœ€æ–° semver tagï¼ˆæ”¯æŒ v å‰ç¼€ï¼‰..."
          LATEST_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG=$(git tag --list '[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n1 || true)
          fi
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="0.0.0"
          fi
          echo "ğŸ”– æœ€æ–° tag -> $LATEST_TAG"

          VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          if ! echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' >/dev/null; then
            echo "âš ï¸ éæ ‡å‡† semverï¼Œå›é€€åˆ° 0.0.0"
            VERSION="0.0.0"
          fi

          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)
          PATCH=$((PATCH + 1))
          if [ "$PATCH" -ge 100 ]; then
            PATCH=0
            MINOR=$((MINOR + 1))
          fi

          NEW_TAG="${MAJOR}.${MINOR}.${PATCH}"
          echo "ğŸ·ï¸ æ–° tag -> $NEW_TAG"

          if git tag --points-at "$MAIN_COMMIT" | grep -E "^(v)?[0-9]+\.[0-9]+\.[0-9]+$" >/dev/null; then
            echo "â­ï¸ å½“å‰ commit å·²æœ‰ tagï¼Œè·³è¿‡"
            exit 0
          fi

          git tag "$NEW_TAG" "$MAIN_COMMIT"
          git push origin "$NEW_TAG"
          echo "âœ… tag $NEW_TAG å·²æ¨é€"

  # ä½œä¸šåç§°ï¼šPublish Packages
  # åŠŸèƒ½æè¿°ï¼š
  #   ä½¿ç”¨ Gradle æ„å»ºé¡¹ç›®å¹¶å°†æ„å»ºäº§ç‰©å‘å¸ƒè‡³ Maven Central å’Œ GitHub Packagesã€‚
  # å‚æ•°è¯´æ˜ï¼š
  #   - éœ€è¦é…ç½®ç¯å¢ƒå˜é‡ MAVEN_USERNAME å’Œ MAVEN_PASSWORD ä»¥è¿›è¡Œè®¤è¯
  # è¿”å›å€¼è¯´æ˜ï¼š
  #   æˆåŠŸå°†åŒ…ä¸Šä¼ è‡³ä¸¤ä¸ªç›®æ ‡ä»“åº“ï¼›å¤±è´¥åˆ™ä¸­æ–­æµç¨‹ã€‚
  publish:
    name: Publish Packages
    runs-on: ubuntu-latest
    # è¡¨ç¤ºæ­¤ job å¿…é¡»ç­‰å¾… tag job å®Œæˆåå†è¿è¡Œ
    needs: [ skip-check, tag ]
    # åŒæ ·æ’é™¤å« ci å…³é”®å­—çš„æäº¤
    if: needs.skip-check.outputs.should_skip == 'false'

    steps:
      # æ­¥éª¤ä¸€ï¼šæ£€å‡ºæºç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤äºŒï¼šå®‰è£… JDK 21 è¿è¡Œç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # æ­¥éª¤ä¸‰ï¼šåˆå§‹åŒ– Gradle ç¯å¢ƒ
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # æ­¥éª¤å››ï¼šèµ‹äºˆ gradlew æ‰§è¡Œæƒé™
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # æ­¥éª¤äº”ï¼šè°ƒè¯•è¾“å‡º JVM å’Œ Gradle ç›¸å…³ä¿¡æ¯
      - name: Debug JVM and Gradle
        run: |
          java -version
          ./gradlew --version
          echo "---- Gradle wrapper properties ----"
          sed -n '1,120p' gradle/wrapper/gradle-wrapper.properties || true

      # æ­¥éª¤å…­ï¼šè°ƒç”¨ Gradle å‘½ä»¤åˆ†åˆ«å‘å¸ƒåˆ°ä¸¤ä¸ªä»“åº“
      - name: Publish to Maven Repositories
        run: |
          ./gradlew publishMavenPublicationToGitHubRepository
          ./gradlew publishMavenPublicationToMavenCentralRepository --no-configuration-cache
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [ skip-check, tag, publish ]
    if: needs.skip-check.outputs.should_skip == 'false'
    steps:
      - name: Checkout (to read changelog if needed)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get latest tag
        id: get_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0)
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          release_name: "Release ${{ steps.get_tag.outputs.tag }}"
          body: "Release created by CI for tag ${{ steps.get_tag.outputs.tag }}"
          draft: false
          prerelease: false

  # ä½œä¸šåç§°ï¼šReset Test Branch
  # åŠŸèƒ½æè¿°ï¼š
  #   å°† test åˆ†æ”¯å¼ºåˆ¶æ›´æ–°ä¸ºå½“å‰ main åˆ†æ”¯çš„çŠ¶æ€ï¼Œä¾¿äºæµ‹è¯•åˆ†æ”¯ä¿æŒå¹²å‡€ä¸€è‡´ã€‚
  # å‚æ•°è¯´æ˜ï¼š
  #   æ— éœ€é¢å¤–å‚æ•°ï¼Œç›´æ¥æ“ä½œ Git åˆ†æ”¯ã€‚
  # è¿”å›å€¼è¯´æ˜ï¼š
  #   test åˆ†æ”¯è¢«é‡æ–°åˆ›å»ºå¹¶å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹ã€‚
  reset-test:
    name: Reset Test Branch
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ä¸€ï¼šæ£€å‡ºæºç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # æ­¥éª¤äºŒï¼šåˆ‡æ¢åˆ° test åˆ†æ”¯å¹¶å¼ºåˆ¶æ¨é€è¦†ç›–è¿œç¨‹åˆ†æ”¯
      - name: Recreate test branch without bot identity
        run: |
          set -euo pipefail
          echo "ğŸ”„ é‡å»º test åˆ†æ”¯..."

          git checkout -B test

          # GitHub ä¼šè‡ªåŠ¨ä½¿ç”¨ github-actions[bot] èº«ä»½æ¨é€ï¼Œä½†è¿™ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨é…ç½®
          git push origin test --force

          echo "âœ… test åˆ†æ”¯å·²é‡å»ºå®Œæˆ"
