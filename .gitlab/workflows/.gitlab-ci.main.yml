stages:
  - tag
  - publish
  - reset
  - mirror

variables:
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

before_script:
  - rm -rf $GRADLE_USER_HOME/.tmp || true

# ğŸ·ï¸ è‡ªåŠ¨æ‰“æ ‡ç­¾
tag:
  stage: tag
  image:
    name: alpine/git:latest
    entrypoint: [ "" ]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /ci/i'
  script:
    - git config --global user.email "pipeline@${GITLAB_URL}"
    - git config --global user.name "Project Pipeline Bot"
    - echo "ğŸ§¹ åˆ é™¤æ‰€æœ‰æœ¬åœ° tag..."
    - git tag -l | xargs -r git tag -d || true
    - echo "ğŸ” æ‹‰å–è¿œç¨‹ tag å’Œ main"
    - git fetch --tags --force --prune
    - git fetch origin main --force
    - MAIN_COMMIT=$(git rev-parse origin/main)
    - echo "ğŸ”— å½“å‰ main commit -> $MAIN_COMMIT"
    - git fetch --tags
    - git fetch origin main
    - MAIN_COMMIT=$(git rev-parse origin/main)
    - echo "ğŸ”— main commit -> $MAIN_COMMIT"

    - LATEST_TAG=$(git tag --list '*' --sort=-v:refname | head -n1 || true)
    - if [ -z "$LATEST_TAG" ]; then LATEST_TAG="0.0.0"; fi
    - echo "ğŸ”– æœ€æ–° tag -> $LATEST_TAG"

    - VERSION=${LATEST_TAG#v}
    - MAJOR=$(echo "$VERSION" | cut -d. -f1)
    - MINOR=$(echo "$VERSION" | cut -d. -f2)
    - PATCH=$(echo "$VERSION" | cut -d. -f3)

    - PATCH=$((PATCH + 1))
    - if [ "$PATCH" -ge 10 ]; then PATCH=0; MINOR=$((MINOR+1)); echo "ğŸ” patch è¾¾åˆ° 10ï¼Œè¿›ä½ï¼šMINOR=$MINOR, PATCH=$PATCH"; fi
    - NEW_TAG="${MAJOR}.${MINOR}.${PATCH}"
    - echo "ğŸ·ï¸ æ–° tag -> $NEW_TAG"

    - if git tag --points-at "$MAIN_COMMIT" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
      echo "â­ï¸ å·²å­˜åœ¨ tagï¼Œè·³è¿‡åˆ›å»º";
      exit 0;
      fi

    - git tag $NEW_TAG $MAIN_COMMIT
    - git push https://oauth2:${PIPELINE_BOT_TOKEN}@${GITLAB_URL}/${CI_PROJECT_PATH}.git $NEW_TAG
    - echo "âœ… tag $NEW_TAG å·²æ¨é€"
    # æ·»åŠ  GitHub è¿œç¨‹å¹¶æ¨é€ tag
    - git remote add github https://x-access-token:${GITHUB_PUSH_TOKEN}@github.com/GeWuYou/forgeboot.git
    - git push github $NEW_TAG
    - echo "âœ… tag $NEW_TAG å·²åŒæ­¥è‡³ GitHub"
  tags:
    - java

# ğŸ“¦ å‘å¸ƒè‡³ GitLab ä¸ GitHub Maven ä»“åº“
publish:
  stage: publish
  needs: [ "tag" ]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /ci/i'
  cache:
    key:
      files:
        - gradle/libs.versions.toml
        - "**/*.gradle.kts"
      prefix: lab-agent
    paths:
      - .gradle/caches/
      - .gradle/wrapper/
      - .gradle/kotlin-profile/
      - .kotlin/
    policy: pull-push
  script:
    - echo "ğŸ”§ æˆäºˆ gradlew æ‰§è¡Œæƒé™..."
    - chmod +x gradlew
    - ./gradlew publishMavenJavaPublicationToGitLabRepository
    - ./gradlew publishMavenJavaPublicationToGitHubRepository --continue
  tags:
    - java

# ğŸ”„ é‡å»º test åˆ†æ”¯
reset:
  stage: reset
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - set -euo pipefail
    - apk add --no-cache git
    - git config --global user.email "pipeline@${GITLAB_URL}"
    - git config --global user.name "Project Pipeline Bot"
    - git clone --branch main https://oauth2:${PIPELINE_BOT_TOKEN}@${GITLAB_URL}/${CI_PROJECT_PATH}.git repo
    - cd repo
    - git checkout -B test
    - git push origin test --force
    - echo "âœ… test åˆ†æ”¯å·²é‡å»ºå®Œæˆ"
  tags:
    - java
#  Mirror to GitHub
mirror-to-github:
  stage: mirror
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - set -euo pipefail
    - apk add --no-cache git openssh
    - git config --global user.name "Project Pipeline Bot"
    - git config --global user.email "pipeline@${GITLAB_URL}"

    - echo "ğŸ”„ æ­£åœ¨ clone å½“å‰ GitLab ä»“åº“..."
    - git clone --branch main https://oauth2:${PIPELINE_BOT_TOKEN}@${GITLAB_URL}/${CI_PROJECT_PATH}.git repo
    - cd repo

    - echo "ğŸ”— æ·»åŠ  GitHub è¿œç¨‹åœ°å€..."
    - git remote add github https://x-access-token:${GITHUB_PUSH_TOKEN}@github.com/GeWuYou/forgeboot.git

    - echo "ğŸš€ æ¨é€ main åˆ†æ”¯åˆ° GitHub..."
    - git push github main --force
    - echo "âœ… GitHub åŒæ­¥å®Œæˆ"
  tags:
    - java
