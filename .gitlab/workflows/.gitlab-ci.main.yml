stages:
  - tag
  - publish
  - reset
  - mirror

variables:
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  GIT_STRATEGY: fetch
  GIT_DEPTH: "0"

before_script:
  - rm -rf "$GRADLE_USER_HOME/.tmp" || true

# -------- å¤ç”¨ç‰‡æ®µï¼ˆanchorsï¼‰ ------------------------------------

# ç»Ÿä¸€é•œåƒï¼šalpine/git + æ¸…ç©º ENTRYPOINTï¼Œé¿å… "git sh" é—®é¢˜
.alpine_git_image: &alpine_git_image
  image:
    name: alpine/git:latest
    entrypoint: [ "" ]

# ç»Ÿä¸€ Git èº«ä»½é…ç½®
.git_identity: &git_identity
  - git config --global user.email "pipeline@${GITLAB_URL}"
  - git config --global user.name "Project Pipeline Bot"

# ç»Ÿä¸€è¿œç«¯åœ°å€å˜é‡ï¼ˆGitLab & GitHubï¼‰
.remotes: &remotes
  - export GL_REPO_URL="https://oauth2:${PIPELINE_BOT_TOKEN}@${GITLAB_URL}/${CI_PROJECT_PATH}.git"
  - export GH_REPO_URL="https://x-access-token:${GITHUB_PUSH_TOKEN}@github.com/GeWuYou/forgeboot.git"

# tag ä»»åŠ¡å¸¸ç”¨å‡†å¤‡ï¼šæ¸…ç†æœ¬åœ° tagã€æ‹‰å–è¿œç«¯ tag å’Œ main
.tag_prepare: &tag_prepare
  - echo "ğŸ§¹ åˆ é™¤æ‰€æœ‰æœ¬åœ° tag..."
  - git tag -l | xargs -r git tag -d || true
  - echo "ğŸ” æ‹‰å–è¿œç¨‹ tag å’Œ main"
  - git fetch --tags --force --prune
  - git fetch origin main --force
  - MAIN_COMMIT=$(git rev-parse origin/main)
  - echo "ğŸ”— å½“å‰ main commit -> $MAIN_COMMIT"

# ğŸ·ï¸ è‡ªåŠ¨æ‰“æ ‡ç­¾
# tag job: åœ¨mainåˆ†æ”¯æäº¤æ—¶è‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€æ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
# å‚æ•°:
#   stage: æŒ‡å®šè¯¥jobå±äºtagé˜¶æ®µ
#   image: æŒ‡å®šä½¿ç”¨alpine/gité•œåƒï¼Œå¹¶æ¸…ç©ºentrypointé¿å…git shé—®é¢˜
#   rules: å®šä¹‰è§¦å‘è§„åˆ™ï¼Œä»…å½“æäº¤åˆ°mainåˆ†æ”¯ä¸”æäº¤ä¿¡æ¯ä¸åŒ…å«"ci"(å¿½ç•¥å¤§å°å†™)æ—¶è§¦å‘
#   script: æ‰§è¡Œæ ‡ç­¾åˆ›å»ºå’Œæ¨é€çš„å…·ä½“è„šæœ¬
#   tags: æŒ‡å®šè¿è¡Œè¯¥jobçš„runneræ ‡ç­¾ä¸ºjava
tag:
  stage: tag
  <<: *alpine_git_image
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /ci/i'
  tags: [ java ]
  before_script:
    - *git_identity
    - *remotes
    - *tag_prepare
  script:
    - echo "ğŸ“¦ è·å–æœ€æ–° tag..."
    # ä½¿ç”¨ git è‡ªå¸¦æ’åºï¼ˆæ— éœ€ coreutils çš„ sort -Vï¼‰
    - LATEST_TAG=$(git tag --list '*' --sort=-v:refname | head -n1 || true)
    - if [ -z "$LATEST_TAG" ]; then LATEST_TAG="0.0.0"; fi
    - echo "ğŸ”– æœ€æ–° tag -> $LATEST_TAG"

    # è§£æ semverï¼ˆä¸å¸¦ v å‰ç¼€ï¼‰
    - VERSION=${LATEST_TAG#v}
    - MAJOR=$(echo "$VERSION" | cut -d. -f1)
    - MINOR=$(echo "$VERSION" | cut -d. -f2)
    - PATCH=$(echo "$VERSION" | cut -d. -f3)

    # è§„åˆ™ï¼špatch +1ï¼Œæ»¡ 10 è¿›ä½åˆ° minor
    - PATCH=$((PATCH + 1))
    - if [ "$PATCH" -ge 10 ]; then PATCH=0; MINOR=$((MINOR+1)); echo "ğŸ” patch è¾¾ 10 è¿›ä½ï¼šMINOR=$MINOR, PATCH=$PATCH"; fi
    - NEW_TAG="${MAJOR}.${MINOR}.${PATCH}"
    - echo "ğŸ·ï¸ æ–° tag -> $NEW_TAG"

    # åŒä¸€ commit ä¸é‡å¤æ‰“ tag
    - if git tag --points-at "$MAIN_COMMIT" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' >/dev/null; then
      echo "â­ï¸ å½“å‰ commit å·²æœ‰ semver tagï¼Œè·³è¿‡";
      exit 0;
      fi

    - git tag "$NEW_TAG" "$MAIN_COMMIT"
    - git push "$GL_REPO_URL" "$NEW_TAG"
    - echo "âœ… tag $NEW_TAG å·²æ¨é€åˆ° GitLab"

    - git remote add github "$GH_REPO_URL" || git remote set-url github "$GH_REPO_URL"
    - git push github "$NEW_TAG"
    - echo "âœ… tag $NEW_TAG å·²åŒæ­¥è‡³ GitHub"

# ğŸ“¦ å‘å¸ƒè‡³ GitLab ä¸ GitHub Maven ä»“åº“
# publish job: å°†æ„å»ºäº§ç‰©å‘å¸ƒåˆ°GitLabå’ŒGitHubçš„Mavenä»“åº“
# å‚æ•°:
#   stage: æŒ‡å®šè¯¥jobå±äºpublishé˜¶æ®µ
#   needs: æŒ‡å®šä¾èµ–tag jobå®Œæˆåå†æ‰§è¡Œ
#   rules: å®šä¹‰è§¦å‘è§„åˆ™ï¼Œä»…å½“æäº¤åˆ°mainåˆ†æ”¯ä¸”æäº¤ä¿¡æ¯ä¸åŒ…å«"ci"(å¿½ç•¥å¤§å°å†™)æ—¶è§¦å‘
#   cache: å®šä¹‰ç¼“å­˜ç­–ç•¥ï¼Œç¼“å­˜Gradleç›¸å…³ç›®å½•ä»¥åŠ é€Ÿæ„å»º
#   script: æ‰§è¡Œå‘å¸ƒåˆ°Mavenä»“åº“çš„å…·ä½“è„šæœ¬
#   tags: æŒ‡å®šè¿è¡Œè¯¥jobçš„runneræ ‡ç­¾ä¸ºjava
publish:
  stage: publish
  needs: [ "tag" ]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE !~ /ci/i'
  cache:
    key:
      files:
        - gradle/libs.versions.toml
        - "**/*.gradle.kts"
      prefix: lab-agent
    paths:
      - .gradle/caches/
      - .gradle/wrapper/
      - .gradle/kotlin-profile/
      - .kotlin/
    policy: pull-push
  tags: [ java ]
  script:
    - echo "ğŸ”§ æˆäºˆ gradlew æ‰§è¡Œæƒé™..."
    - chmod +x gradlew
    - ./gradlew publishMavenPublicationToGitLabRepository
    - ./gradlew publishMavenPublicationToGitHubRepository --continue
    - ./gradlew publishMavenPublicationToMavenCentralRepository --no-configuration-cache
    - echo "âœ… å‘å¸ƒå®Œæˆ"

# ğŸ”„ é‡å»º test åˆ†æ”¯
# reset job: åŸºäºmainåˆ†æ”¯é‡å»ºteståˆ†æ”¯
# å‚æ•°:
#   stage: æŒ‡å®šè¯¥jobå±äºreseté˜¶æ®µ
#   image: æŒ‡å®šä½¿ç”¨alpine/gité•œåƒï¼Œå¹¶æ¸…ç©ºentrypointé¿å…git shé—®é¢˜
#   rules: å®šä¹‰è§¦å‘è§„åˆ™ï¼Œä»…å½“æäº¤åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
#   script: æ‰§è¡Œé‡å»ºteståˆ†æ”¯çš„å…·ä½“è„šæœ¬
#   tags: æŒ‡å®šè¿è¡Œè¯¥jobçš„runneræ ‡ç­¾ä¸ºjava
reset:
  stage: reset
  <<: *alpine_git_image
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags: [ java ]
  before_script:
    - *git_identity
    - *remotes
  script:
    - set -euo pipefail
    - echo "ğŸ”„ é‡å»º test åˆ†æ”¯..."
    - git clone --branch main "$GL_REPO_URL" repo
    - cd repo
    - git checkout -B test
    - git push -o ci.skip origin test --force
    - echo "âœ… test åˆ†æ”¯å·²é‡å»ºå®Œæˆï¼ˆå·²è·³è¿‡ CIï¼‰"

# ğŸ” åŒæ­¥åˆ° GitHub
# mirror-to-github job: å°†GitLabçš„mainåˆ†æ”¯åŒæ­¥åˆ°GitHub
# å‚æ•°:
#   stage: æŒ‡å®šè¯¥jobå±äºmirroré˜¶æ®µ
#   image: æŒ‡å®šä½¿ç”¨alpine/gité•œåƒï¼Œå¹¶æ¸…ç©ºentrypointé¿å…git shé—®é¢˜
#   rules: å®šä¹‰è§¦å‘è§„åˆ™ï¼Œä»…å½“æäº¤åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
#   script: æ‰§è¡ŒåŒæ­¥åˆ°GitHubçš„å…·ä½“è„šæœ¬
#   tags: æŒ‡å®šè¿è¡Œè¯¥jobçš„runneræ ‡ç­¾ä¸ºjava
mirror-to-github:
  stage: mirror
  <<: *alpine_git_image
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  tags: [ java ]
  before_script:
    - *git_identity
    - *remotes
  script:
    - set -euo pipefail
    - echo "ğŸ”„ clone GitLab ä»“åº“..."
    - git clone --branch main "$GL_REPO_URL" repo
    - cd repo
    - echo "ğŸ”— æ·»åŠ /æ›´æ–° GitHub è¿œç¨‹..."
    - git remote add github "$GH_REPO_URL" || git remote set-url github "$GH_REPO_URL"
    - echo "ğŸš€ æ¨é€ main åˆ° GitHub..."
    - git push github main --force
    - echo "âœ… GitHub åŒæ­¥å®Œæˆ"
