stages:
  - build
  - tag
  - publish
  - reset
  - mirror

variables:
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

before_script:
  - rm -rf $GRADLE_USER_HOME/.tmp || true

# âœ… Build é˜¶æ®µ
build:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  cache:
    key:
      files:
        - gradle/libs.versions.toml
        - "**/*.gradle.kts"
      prefix: lab-agent
    paths:
      - .gradle/caches/
      - .gradle/wrapper/
      - .gradle/kotlin-profile/
      - .kotlin/
    policy: pull-push
  script:
    - echo "ğŸ”§ æˆäºˆ gradlew æ‰§è¡Œæƒé™..."
    - chmod +x gradlew
    - ./gradlew clean build
  tags:
    - java

# ğŸ·ï¸ è‡ªåŠ¨æ‰“æ ‡ç­¾
tag:
  stage: tag
  needs: [ "build" ]
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - set -euo pipefail
    - apk add --no-cache git
    - git config --global user.email "pipeline@${GITLAB_URL}"
    - git config --global user.name "Project Pipeline Bot"
    - git fetch --tags
    - git fetch origin main
    - MAIN_COMMIT=$(git rev-parse origin/main)
    - echo "ğŸ”— main commit -> $MAIN_COMMIT"

    - LATEST_TAG=$(git tag --list '*' --sort=-v:refname | head -n1 || true)
    - if [ -z "$LATEST_TAG" ]; then LATEST_TAG="0.0.0"; fi
    - echo "ğŸ”– æœ€æ–° tag -> $LATEST_TAG"

    - VERSION=${LATEST_TAG#v}
    - MAJOR=$(echo "$VERSION" | cut -d. -f1)
    - MINOR=$(echo "$VERSION" | cut -d. -f2)
    - PATCH=$(echo "$VERSION" | cut -d. -f3)

    - PATCH=$((PATCH + 1))
    - NEW_TAG="${MAJOR}.${MINOR}.${PATCH}"
    - echo "ğŸ·ï¸ æ–° tag -> $NEW_TAG"

    - if git tag --points-at "$MAIN_COMMIT" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' > /dev/null; then
      echo "â­ï¸ å·²å­˜åœ¨ tagï¼Œè·³è¿‡åˆ›å»º";
      exit 0;
      fi

    - git tag $NEW_TAG $MAIN_COMMIT
    - git push https://oauth2:${PIPELINE_BOT_TOKEN}@${GITLAB_URL}/${CI_PROJECT_PATH}.git $NEW_TAG
    - echo "âœ… tag $NEW_TAG å·²æ¨é€"
  tags:
    - java

# ğŸ“¦ å‘å¸ƒè‡³ GitLab Maven ä»“åº“
publish:
  stage: publish
  needs: [ "tag" ]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - echo "ğŸ”§ æˆäºˆ gradlew æ‰§è¡Œæƒé™..."
    - chmod +x gradlew
    - ./gradlew publishMavenJavaPublicationToGitLabRepository
  tags:
    - java

# ğŸ”„ é‡å»º test åˆ†æ”¯
reset:
  stage: reset
  needs: [ "build" ]
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - set -euo pipefail
    - apk add --no-cache git
    - git config --global user.email "pipeline@${GITLAB_URL}"
    - git config --global user.name "Project Pipeline Bot"
    - git clone --branch main https://oauth2:${PIPELINE_BOT_TOKEN}@${GITLAB_URL}/${CI_PROJECT_PATH}.git repo
    - cd repo
    - git checkout -B test
    - git push origin test --force
    - echo "âœ… test åˆ†æ”¯å·²é‡å»ºå®Œæˆ"
  tags:
    - java
#  Mirror to GitHub
mirror-to-github:
  stage: mirror
  needs: [ "build" ]
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - set -euo pipefail
    - apk add --no-cache git openssh
    - git config --global user.name "Project Pipeline Bot"
    - git config --global user.email "pipeline@${GITLAB_URL}"

    - echo "ğŸ”„ æ­£åœ¨ clone å½“å‰ GitLab ä»“åº“..."
    - git clone --depth=1 --branch main https://oauth2:${PIPELINE_BOT_TOKEN}@${GITLAB_URL}/${CI_PROJECT_PATH}.git repo
    - cd repo

    - echo "ğŸ”— æ·»åŠ  GitHub è¿œç¨‹åœ°å€..."
    - git remote add github https://x-access-token:${GITHUB_PUSH_TOKEN}@github.com/GeWuYou/forgeboot.git

    - echo "ğŸš€ æ¨é€ main åˆ†æ”¯åˆ° GitHub..."
    - git push github main --force
    - echo "âœ… GitHub åŒæ­¥å®Œæˆ"
  tags:
    - java
