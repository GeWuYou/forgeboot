stages:
  - check
before_script:
  - export GRADLE_USER_HOME=$CI_PROJECT_DIR/.gradle
  - rm -rf $CI_PROJECT_DIR/.gradle/.tmp || true
# âœ… check Job
check:
  stage: check
  cache:
    key:
      files:
        - gradle/libs.versions.toml
        - "**/build.gradle.kts"
      prefix: lab-agent
    paths:
      - .gradle/caches/
      - .gradle/wrapper/
      - .gradle/kotlin-profile/
      - .kotlin/
      - buildSrc/.gradle/
      - buildSrc/build/
    policy: pull-push
  script:
    - echo "ğŸ”§ æˆäºˆ gradlew æ‰§è¡Œæƒé™..."
    - chmod +x gradlew

    - echo "ğŸ§ª å¼€å§‹å¿«é€Ÿç¼–è¯‘æ£€æŸ¥ï¼ˆè·³è¿‡æ‰“åŒ…å’Œæµ‹è¯•ï¼‰..."
    - ./gradlew compileKotlin compileJava --stacktrace || (echo "âŒ ç¼–è¯‘å¤±è´¥ï¼è¯·æ£€æŸ¥é”™è¯¯æ—¥å¿—" && exit 1)

    - echo "ğŸ“¦ å½“å‰ç¼“å­˜ç›®å½•ï¼š"
    - ls -la .gradle/

    - echo "ğŸ“¦ Gradle ç¼“å­˜ç»“æ„æ£€æŸ¥"
    - ls -la .gradle/caches/modules-2/files-2.1 || true
    - echo "ğŸ“¦ ç¼“å­˜æ–‡ä»¶æ•°é‡ï¼š$(find .gradle/caches/modules-2/files-2.1 -type f | wc -l)"

    - echo "ğŸ›‘ åœæ­¢ Gradle å®ˆæŠ¤è¿›ç¨‹..."
    - ./gradlew --stop

    - echo "ğŸ” å½“å‰ Java è¿›ç¨‹ï¼š"
    - ps aux | grep java || true
  tags:
    - docker
    - java